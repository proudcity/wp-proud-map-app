!function($){angular.module("scrollTo",[]).run(["$rootScope",function($rootScope){/* currentYPosition -
      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
var currentYPosition=function(){
// Firefox, Chrome, Opera, Safari
// Firefox, Chrome, Opera, Safari
// Internet Explorer 6 - standards mode
// Internet Explorer 6, 7 and 8
return window.pageYOffset?window.pageYOffset:document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop?document.body.scrollTop:0};$rootScope.currentYPosition=currentYPosition,/* scrollTo -
      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
$rootScope.scrollTo=function(eID,scrollDiv,quick){/* scrollTo -
        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
function elmYPosition(eID){if(eID){for(var elm=document.getElementById(eID),y=elm.offsetTop,node=elm;node.offsetParent&&node.offsetParent!=document.body;)node=node.offsetParent,y+=node.offsetTop;return y}}
// This scrolling function 
// is from http://www.itnewb.com/tutorial/Creating-the-Smooth-Scroll-Effect-with-JavaScript
var i,startY=currentYPosition(),stopY=elmYPosition(eID),distance=stopY>startY?stopY-startY:startY-stopY;if(100>distance||quick)return void scrollTo(0,stopY);var speed=Math.round(distance/100);speed>=20&&(speed=20);var step=Math.round(distance/25),leapY=stopY>startY?startY+step:startY-step,timer=0;if(stopY>startY)for(i=startY;stopY>i;i+=step)setTimeout("window.scrollTo(0, "+leapY+")",timer*speed),leapY+=step,leapY>stopY&&(leapY=stopY),timer++;else for(i=startY;i>stopY;i-=step)setTimeout("window.scrollTo(0, "+leapY+")",timer*speed),leapY-=step,stopY>leapY&&(leapY=stopY),timer++}}]),
//***************************************
// Main Application
//***************************************
angular.module("mapAppParent",["mapApp","angular-inview","angular-lazycompile"]).run(["$rootScope","$window","$location",function($rootScope,$window,$location){$rootScope.mapboxAccessToken="pk.eyJ1IjoiYWxiYXRyb3NzZGlnaXRhbCIsImEiOiI1cVUxbUxVIn0.SqKOVeohLfY0vfShalVDUw",$rootScope.mapboxMap="albatrossdigital.lpkdpcjb",$rootScope.proudcityApi="http://my.getproudcity.com/api/proudcity/",$rootScope.proxyUrl=$rootScope.proudcityApi+"proxy",$rootScope.paymentUrl=$rootScope.proudcityApi+"invoice-example"}]).controller("MapControl",["$scope","$rootScope","$filter","$http",function($scope,$rootScope,$filter,$http){Proud=Proud||{};var $state={params:{city:_.get(Proud,"settings.global.location.city")||"seattle",state:_.get(Proud,"settings.global.location.state")||"washington"}},ucWords=function(str){return(str+"").replace("-"," ").replace(/^([a-z\u00E0-\u00FC])|\s+([a-z\u00E0-\u00FC])/g,function($1){return $1.toUpperCase()})};$scope.location={state:ucWords($state.params.state),city:ucWords($state.params.city),key:{state:$state.params.state,city:$state.params.city}},$scope.settings={color:{main:"#000",secondary:"#000",highlight:"#2196F3"},header:{backgroundType:"image",backgroundImage:"",backgroundColor:"",searchColor:"#FFFFFF",searchAlign:"left"}};
//$http.get($rootScope.proudcityApi +'?state='+ $state.params.state +'&city='+ $state.params.city).success(function(data){
// Proud options
var data={};data.lat=_.get(Proud,"settings.global.location.lat")||data.lat,data.lng=_.get(Proud,"settings.global.location.lng")||data.lng,$scope.location={city:_.get(Proud,"settings.global.location.city")||data.lat,state:_.get(Proud,"settings.global.location.state")||data.state},$scope.settings=_.merge(data,$scope.settings)}]).directive("mapParent",function(){return{restrict:"A",controller:"MapControl",template:'<div foursquare-map="settings" />'}}),angular.module("mapApp",["ngSanitize","ngResource"]).run(["$rootScope","$window","$location",function($rootScope,$window,$location){
// Capture url for back button
$rootScope.$on("$locationChangeSuccess",function(){$rootScope.actualLocation=$location.absUrl()})}]).directive("foursquareMap",function($window,$browser,$http,$location,$rootScope){return{restrict:"A",templateUrl:"views/apps/mapApp/map.html",replace:!1,scope:{foursquareMap:"="},link:function($scope,$element,$attrs){$scope.details={};var $mapWrap=$("#map-wrapper"),$body=$("body");
// Set up full screen action
$scope.toggleFullScreen=function(e){e&&(e.preventDefault(),e.stopPropagation()),$rootScope.fullScreen=!$rootScope.fullScreen,$body.toggleClass("proud-map-fullscreen")},
// Expand map if closed
$mapWrap.click(function(e){$rootScope.fullScreen||($scope.toggleFullScreen(e),window.map.invalidateSize())}),
// Listen for esc key
$body.keydown(function(e){//keypress did not work with ESC;
"27"==e.which&&$rootScope.fullScreen&&$scope.toggleFullScreen()}),
// Listen for back button
$rootScope.$watch(function(){return $location.absUrl()},function(newLocation,oldLocation){$rootScope.actualLocation===newLocation&&$rootScope.fullScreen&&$scope.toggleFullScreen()}),
// Slide filters for mobile
$scope.toggleFilter=function(){return $mapWrap.toggleClass("filter-open"),!1},
// Make details close link
$("#details-close").click(function(){return $mapWrap.removeClass("details-open"),!1}),$scope.$watch("foursquareMap",function(settings){
//addLayer('Restaurants', 'foursquare', 15, {query: 'restaurant'});
//addLayer('Entertainment', 'foursquare', 14, {query: 'entertainment'});
//addLayer('Flu Shots', 'foursquare', 13, {query: 'flu'}, foursquareDefault);
//addLayer('Events', 'drupal', 14, {url: settings.helm_civic_map.drupal_events});
//}
// @todo: http://www.opencyclemap.org/
// @todo: hiking map
function addLayer(name,type,zoom,params,active){active=void 0==active?!1:active;
//layer
//  .setZIndex(zIndex)
//  .addTo(map);
// Create a simple layer switcher that
// toggles layers on and off.
var link=document.createElement("a");link.href="#",link.className=active?"active":"",link.innerHTML=name,link.onclick=function(e){e.preventDefault(),e.stopPropagation();for(var key in mapLayers)map.removeLayer(mapLayers[key]);switch(void 0!=gridControl&&(map.removeControl(gridControl),gridControl=void 0),
//attr = L.control.attribution({prefix: false}).addTo('map');
map.setView(new L.LatLng(config.lat,config.lng),zoom,{animate:!0}),$("#menu-ui a.active").removeClass("active"),map.invalidateSize(),this.className="active",type){case"foursquare":if(Array.isArray(params.query))for(var i=0;i<params.query.length;i++)addFoursquareLayer(params.query[i],"small");else addFoursquareLayer(params.query,"large");
//attr.addAttribution('<a href="http://foursquare.com">Foursquare</a>');
map.attributionControl.setPrefix('Data from <a href="http://foursquare.com">Foursquare</a>');break;case"seeclickfix":addSeeClickFixLayer("closed"),addSeeClickFixLayer("open"),addSeeClickFixLayer("acknowledged"),map.attributionControl.setPrefix('Data from <a href="http://seeclickfix.com">SeeClickFix</a>');break;case"drupal":addFoursquareLayer(params.query),map.attributionControl.setPrefix('Data from <a href="/">this website</a>');
//attr.addAttribution('This website');
break;case"mbtiles":tile=L.mapbox.tileLayer(params.url).addTo(window.activeLayer),grid=L.mapbox.gridLayer(params.url).addTo(window.activeLayer),gridControl=L.mapbox.gridControl(grid,{follow:!0}).addTo(map)}
// If actual click, then toggle filters
layersInit&&$scope.toggleFilter()},active&&$(link).trigger("click"),layers.appendChild(link)}function addFoursquareLayer(query,size){/* Query Foursquare API for venue recommendations near the current location. */
//if (mapLayers[query] != undefined) {
//  console.log(mapLayers[query]);
//  mapLayers[query].addTo(map);
//}
//else {
var url=config.apiUrl+"v2/venues/explore?ll="+config.lat+","+config.lng+"&query="+query+"&client_id="+config.clientKey+"&client_secret="+config.clientSecret+"&v=20140601";$.getJSON(url,{},function(data){/* Place marker for each venue. */
for(var venues=data.response.groups[0].items,geojson=(L.mapbox.featureLayer(),{type:"FeatureCollection",features:[]}),i=0;i<venues.length;i++){var category=venues[i].venue.categories[0].name,color="#997C61",icon="star";-1!=category.indexOf("Library")?(icon="library",color="#A973A9"):-1!=category.indexOf("School")||-1!=category.indexOf("College")||-1!=category.indexOf("University")?(icon="college",color="#ED9356"):-1!=category.indexOf("Police")?(icon="police",color="#456D9C"):-1!=category.indexOf("Fire")?(icon="fire-station",color="#E76C6D"):-1!=category.indexOf("Post")?(icon="post",color="#5A97C4"):("park"==query||-1!=category.indexOf("Park"))&&(icon="park2",color="#9BBF6A"),geojson.features.push({type:"Feature",properties:{title:venues[i].venue.name,"marker-color":color,"marker-size":size,"marker-symbol":icon,url:void 0!=venues[i].venue.url?venues[i].venue.url:void 0,details:venues[i].venue},geometry:{type:"Point",coordinates:[venues[i].venue.location.lng,venues[i].venue.location.lat]}})}//for
mapLayers[query]=L.mapbox.featureLayer().setGeoJSON(geojson),mapLayers[query].on("mouseover",function(e){e.layer.openPopup()}).on("mouseout",function(e){e.layer.closePopup()}).on("click",function(e){var props=e.layer.feature.properties.details;$mapWrap.addClass("details-open"),
//if (e.layer.feature.properties.url != undefined) {
//  window.location = props.url;
//}d
//else {
$scope.details=props,$scope.$apply();var url="https://maps.googleapis.com/maps/api/place/search/json?"+$.param({location:e.layer.feature.geometry.coordinates[1]+","+e.layer.feature.geometry.coordinates[0],type:query.replace(" station",""),search:props.title,key:"AIzaSyAqSVs6Hsk1EjKiSa4TV9fykhB7K3ijkaM",sensor:!0,radius:250});$.getJSON($scope.$parent.$root.proxyUrl+"?url="+encodeURIComponent(url),{},function(data){if("OK"==data.status&&data.results[0]){var url="https://maps.googleapis.com/maps/api/place/details/json?"+$.param({key:"AIzaSyAqSVs6Hsk1EjKiSa4TV9fykhB7K3ijkaM",placeid:data.results[0].place_id});$.getJSON($scope.$parent.$root.proxyUrl+"?url="+encodeURIComponent(url),{},function(data){"OK"==data.status&&void 0!=data.result&&($scope.details.website=data.result.website,$scope.googleLocal=data.result,$scope.googleLocal.hours=void 0!=data.result.opening_hours?data.result.opening_hours.weekday_text.join("<br/>"):!1,$scope.$apply())})}})}),mapLayers[query].addTo(map)})}function addSeeClickFixLayer(status){var query="seeclickfix "+status,geojson=(L.mapbox.featureLayer(),{type:"FeatureCollection",features:[]}),url="https://seeclickfix.com/api/v2/issues?&callback=?&"+$.param({lat:config.lat,lng:config.lng,zoom:map.getZoom()-1,per_page:50,sort:"created_at",status:status});$.getJSON(url,{},function(data){/* Place marker for each venue. */
for(var venues=data.issues,i=0;i<venues.length;i++){var props=venues[i],color="Acknowledged"==props.status?"#E3B14D":"Open"==props.status?"#E76C6D":"Closed"==props.status?"#9BBF6A":"#CCCCCC";// Archived;
props["marker-color"]=color,props["marker-size"]="small",props["marker-symbol"]=void 0!=props.media.image_full?"star":"star-stroked",props.title=props.summary,
//props.body = props.description;
//angular.copy(props.description, props.body);
props.description='<div class="seeclickfix-status status-'+props.status+'">'+props.status+'</div><div class="date">Reported on '+props.created_at+"</div>",geojson.features.push({type:"Feature",properties:props,geometry:{type:"Point",coordinates:[venues[i].lng,venues[i].lat]}})}//for
mapLayers[query]=L.mapbox.featureLayer().setGeoJSON(geojson),mapLayers[query].on("mouseover",function(e){e.layer.openPopup()}).on("mouseout",function(e){e.layer.closePopup()}).on("click",function(e){$mapWrap.addClass("details-open");var props=e.layer.feature.properties;
//console.log(e.layer.feature);
//if (e.layer.feature.properties.url != undefined) {
//  window.location = props.url;
//}d
//else {
$scope.seeclickfix=props,$scope.$apply()}),mapLayers[query].addTo(map)})}if(_.has(settings,"lat")){var config={clientKey:"1CAZ5UW5UDQ2F1EDEHFOULURU4K3RBWWITBOONJ2XLXPD52V",clientSecret:"GA4DAN4KLI5UM0VJ4BAZAE4SEVLIR0BC5B4UKGNVR2VJXXWN",authUrl:"https://foursquare.com/",apiUrl:"https://api.foursquare.com/",lat:settings.lat,lng:settings.lng};
// @todo: get from $rootSCope
L.mapbox.accessToken="pk.eyJ1IjoiYWxiYXRyb3NzZGlnaXRhbCIsImEiOiI1cVUxbUxVIn0.SqKOVeohLfY0vfShalVDUw";var map=new L.mapbox.Map("map","albatrossdigital.lpkdpcjb",{center:new L.LatLng(config.lat,config.lng),zoom:15,scrollWheelZoom:!1,zoomControl:!1});new L.Control.Zoom({position:"topright"}).addTo(map),window.map=map;var gridControl,layersInit=!1,// 
layers=document.getElementById("menu-ui"),mapLayers={},foursquareDefault=!0;44.5667==config.lat&&(addLayer("Public Transit","mbtiles",14,{url:settings.helm_civic_map.transportation,attribution:'<a href="ftp://ftp.ci.corvallis.or.us/pw/Transportation/GoogleTransitFeed/">City of Corvallis GTFS</a>'},!0),foursquareDefault=!1),
//for (var i=0; i<params.query.length; i++) {
//  addFoursquareLayer(params.query[i]);
//}
foursquareDefault=!0,addLayer("All Services","foursquare",13,{query:["government","school","police station","fire station","library","post office","park"]},foursquareDefault),addLayer("Schools","foursquare",13,{query:"school"}),addLayer("Police","foursquare",12,{query:"police station"}),addLayer("Fire","foursquare",12,{query:"fire station"}),addLayer("Libraries","foursquare",13,{query:"library"}),addLayer("Post Offices","foursquare",13,{query:"post office"}),addLayer("Parks","foursquare",14,{query:"park"}),addLayer("Reported Issues","seeclickfix",14,{query:"seeclickfix"}),layersInit=!0}})}}})}(jQuery);